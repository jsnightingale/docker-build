#!/bin/bash

set -e

HTTPSREGEX="^https?://"
URLREGEX="[-A-Za-z0-9\+&@#/%?=~_|!:,.;]*[-A-Za-z0-9\+&@#/%=~_|]"

echo -n "Enter the url of the git repsoitory you would like to clone: "
read REPOSITORY
if [[ $REPOSITORY =~ $HTTPSREGEX ]]; then

    git clone $REPOSITORY site
else 
    echo "We didn't like that input. Exiting..."
    exit 1
fi

echo "Creating a env file..."
  	cat >> site/.env <<EOL
APP_ENV=local
APP_DEBUG=true
APP_KEY=

DB_HOST=mysql
CACHE_DRIVER=redis
SESSION_DRIVER=redis
REDIS_HOST=redis
EOL
fi

# # export $(cat "$LOCALFOLDER/.env" | grep -v ^# | xargs);

export APP_PORT=${APP_PORT:-80}
export APP_ENV=${APP_ENV:-local}
export DB_PORT=${DB_PORT:-3306}
export DB_ROOT_PASS=${DB_ROOT_PASS:-root}
export DB_NAME=${DB_NAME:-arena}
export DB_USER=${DB_USER:-arena}
export DB_PASS=${DB_PASS:-root}

cd app

./develop composer install

sleep 5

./develop art key:generate

 sleep 5

./develop npm install

sleep 5

# echo Starting mysql and nginx...
./develop up -d app mysql scheduler redis

sleep 5

until ./develop exec mysql mysql -h 127.0.0.1 -u $DB_USER -p$DB_PASS -D $DB_NAME --silent -e "show databases;"
do
  echo "Waiting for database connection..."
  sleep 5
done

if [ $DB_PASS = 'root' ];
then
    echo Database Migration Started!
   
    docker-compose exec app php artisan migrate --path="database/migrations/db-calldetails";
    docker-compose exec app php artisan migrate --path="database/migrations/db-coredb";
    docker-compose exec app php artisan migrate --path="database/migrations/db-arena";
    echo Database Migration Finished!

    sleep 5

    echo Database Seeding Started!
    docker-compose exec app php artisan db:seed --class=ConfigSeeder;
    docker-compose exec app php artisan db:seed --class=WhiteLabelSeeder;
    docker-compose exec app php artisan db:seed --class=CustomerSeeder;
    docker-compose exec app php artisan db:seed --class=CallingPlanSeeder;
    docker-compose exec app php artisan db:seed --class=NumberClassSeeder;
    docker-compose exec app php artisan db:seed --class=LineNumberAvailableDatabaseSeeder;
    docker-compose exec app php artisan db:seed --class=DeviceProvisionSeeder;
    docker-compose exec app php artisan db:seed --class=CallDetailsToBillDatabaseSeeder;
    docker-compose exec app php artisan db:seed --class=UserSeeder;
    echo Database Seeding Completed!
fi

echo Starting queue...
./develop up -d queue

echo Installation Complete!